#!/usr/bin/env bash
# Generate docs/tree.txt and docs/issues.json on each commit, then stage them.
# This is a standardized hook for all projects.

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"
mkdir -p docs

# 1) Project tree (respects .gitignore)
if command -v tree >/dev/null 2>&1; then
  # Use --gitignore if supported, otherwise fall back to ignoring common patterns
  if tree --help 2>&1 | grep -q -- '--gitignore'; then
    tree --gitignore -a -I ".git|node_modules|vendor|.DS_Store|*.log|*.db|coverage.*|bin|tmp|test-output|test-results|build" -o docs/tree.txt .
  else
    tree -a -I ".git|node_modules|vendor|.DS_Store|*.log|*.db|coverage.*|bin|tmp|test-output|test-results|build" -o docs/tree.txt .
  fi
  echo "[pre-commit] Generated docs/tree.txt"
else
  echo "[pre-commit] 'tree' not found; install it to generate docs/tree.txt" >&2
  echo "[pre-commit] On macOS: brew install tree" >&2
  # Fallback: use find to generate a simple tree
  find . -type d -name '.git' -prune -o \
         -type d -name 'node_modules' -prune -o \
         -type d -name 'vendor' -prune -o \
         -type d -name 'bin' -prune -o \
         -type d -name 'build' -prune -o \
         -type f -name '.DS_Store' -prune -o \
         -type f -print | sort > docs/tree.txt
  echo "[pre-commit] Generated fallback docs/tree.txt using find"
fi

# 2) GitHub issues (requires GitHub CLI 'gh' and auth)
if command -v gh >/dev/null 2>&1; then
  if gh auth status >/dev/null 2>&1; then
    # Get owner/repo from current remote
    OWNER_REPO="$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || true)"
    if [[ -n "${OWNER_REPO:-}" ]]; then
      echo "[pre-commit] Fetching GitHub issues for $OWNER_REPO..."
      gh issue list -R "$OWNER_REPO" --state all --limit 9999 --json \
        number,title,body,state,labels,assignees,milestone,createdAt,updatedAt,closedAt,author,comments \
        > docs/issues.json || echo "[pre-commit] Failed to fetch issues" >&2
      
      # Pretty print the count of issues
      if [[ -f docs/issues.json ]]; then
        ISSUE_COUNT=$(cat docs/issues.json | grep -o '"number"' | wc -l | tr -d ' ')
        echo "[pre-commit] Exported $ISSUE_COUNT issues to docs/issues.json"
      fi
    else
      echo "[pre-commit] Could not determine owner/repo" >&2
      echo "[pre-commit] Make sure you have a git remote configured" >&2
    fi
  else
    echo "[pre-commit] GitHub CLI 'gh' not authenticated; skipping issues export" >&2
    echo "[pre-commit] Run: gh auth login" >&2
  fi
else
  echo "[pre-commit] GitHub CLI 'gh' not found; skipping issues export" >&2
  echo "[pre-commit] Install with: brew install gh" >&2
fi

# Stage generated files for this commit (only if they exist)
[[ -f docs/tree.txt ]] && git add docs/tree.txt
[[ -f docs/issues.json ]] && git add docs/issues.json

exit 0
